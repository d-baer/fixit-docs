{{- /*
  * Renders the content of the current page's translation in the specified language.
  * @param {string} The language key of site from which to retrieve the translation.
  * @example {{< missing-translation >}}
  * @example {{< missing-translation zh-cn >}}
  * @returns {template.HTML}
- */}}

{{- $edit := printf "https://github.com/hugo-fixit/docs/edit/main/%v/%v" .Site.Params.gitInfo.Dir .Page.File.Path -}}
{{- $tip := "> [!help]+ Missing translation\n> This page is not yet translated. You can [help translate](%v) it." -}}
{{- if eq .Page.Lang "zh-cn" -}}
  {{- $tip = "> [!help]+ 缺少翻译\n> 本文尚未翻译完成，欢迎 [参与翻译](%v)。" -}}
{{- end -}}
{{- $tip = printf $tip $edit -}}

{{- $sourceLanguage := .Get 0 -}}
{{- if (not $sourceLanguage) | and (gt $.Page.Translations.Len 0) }}
  {{- $sourceLanguage = (index $.Page.Translations 0).Language.Lang }}
{{- end }}
{{- $translateRefPage := "" }}

{{- with $sourceLanguage }}
  {{- if eq $.Page.Language.Lang $sourceLanguage }}
    {{- errorf "The positional parameter passed to the %q shortcode must not be the language key of the current site. See %s" $.Name $.Position }}
  {{- else }}
    {{- with index (where $.Page.Translations "Language.Lang" $sourceLanguage) 0 }}
      {{- $translateRefPage = . -}}
    {{- else }}
      {{- errorf "The %q shortcode was unable to find a %q translation of the %q page. See %s" $.Name $sourceLanguage $.Page.Path $.Position }}
    {{- end }}
  {{- end }}
{{- else }}
  {{- errorf "The %q shortcode requires a positional parameter indicating the source language key. See %s" $.Name $.Position }}
{{- end -}}

{{- with $translateRefPage }}
  {{- if eq $.Page.Lang "zh-cn" -}}
    {{- $tip = add $tip (printf "请参考 [%q](%s) 的内容。" .Title .RelPermalink) -}}
  {{- else -}}
    {{- $tip = add $tip (printf "  \nPlease refer to the content of [%q](%s)." .Title .RelPermalink) -}}
  {{- end -}}
  {{- $tip | $.Page.RenderString -}}
  {{- if ne hugo.Context.MarkupScope "home" -}}
    {{/*  <div class="missing-translation">{{ .RenderShortcodes }}</div>  */}}
    <div class="missing-translation">{{ .Content }}</div>
  {{- end -}}
{{- end -}}
